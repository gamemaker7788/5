<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>格鲁吉亚行程卡片</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* 样式同你原来，省略节省篇幅；下面只贴核心脚本 */
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
body{background:#f5f7fa;color:#333;line-height:1.6;padding:20px}
.container{max-width:1400px;margin:0 auto}
header{background:linear-gradient(to right,#2c3e50,#34495e);color:#fff;padding:1.5rem;margin-bottom:2rem;border-radius:10px;text-align:center}
h1{font-size:2rem;margin-bottom:.5rem}
.subtitle{font-size:1.1rem;opacity:.9}
.filters{background:#fff;border-radius:10px;padding:1.5rem;margin-bottom:2rem;display:flex;gap:1rem;flex-wrap:wrap}
.filter-item{flex:1;min-width:200px}
.filter-item label{display:block;margin-bottom:.5rem;font-weight:600}
.filter-item input,.filter-item select{width:100%;padding:.8rem;border:1px solid #ddd;border-radius:4px}
.btn{display:inline-block;padding:.8rem 1.5rem;background:#3498db;color:#fff;border:none;border-radius:5px;cursor:pointer;margin-right:.5rem}
.btn:hover{background:#2980b9}
.cards-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:1.5rem;margin-bottom:2rem}
.itinerary-card{background:#fff;border-radius:10px;padding:1.5rem;box-shadow:0 2px 4px rgba(0,0,0,.1);transition:transform .3s,box-shadow .3s}
.itinerary-card:hover{transform:translateY(-5px);box-shadow:0 6px 12px rgba(0,0,0,.15)}
.card-header{border-bottom:2px solid #3498db;padding-bottom:1rem;margin-bottom:1rem;display:flex;justify-content:space-between;align-items:center}
.order-number-section{background:linear-gradient(135deg,#e3f2fd,#bbdefb);padding:1rem;border-radius:8px;margin-bottom:1rem;border-left:4px solid #1976d2}
.order-number-label{font-weight:600;color:#1976d2;margin-right:.5rem}
.order-number-value{font-family:'Courier New',monospace;font-size:1.1rem;font-weight:bold;color:#1565c0}
.copy-order-btn{background:#1976d2;color:#fff;border:none;padding:.3rem .6rem;border-radius:4px;cursor:pointer;font-size:.8rem;margin-left:.5rem}
.copy-order-btn:hover{background:#1565c0}
.card-section{margin-bottom:1rem}
.card-section h3{color:#2c3e50;margin-bottom:.5rem;font-size:1rem;border-bottom:1px solid #ecf0f1}
.info-item{display:flex;margin-bottom:.5rem;font-size:.9rem}
.info-label{font-weight:600;color:#555;min-width:80px;margin-right:.5rem}
.day-item{background:#f8f9fa;padding:.5rem;margin-bottom:.5rem;border-radius:4px;font-size:.85rem}
.passenger-item,.service-item{display:flex;justify-content:space-between;padding:.3rem 0;border-bottom:1px solid #eee;font-size:.85rem}
.navigation{display:flex;justify-content:center;align-items:center;gap:1rem;margin-top:1rem}
.nav-btn{background:#3498db;color:#fff;border:none;border-radius:5px;padding:.5rem 1rem;cursor:pointer}
.nav-btn:hover:not(:disabled){background:#2980b9}
.nav-btn:disabled{background:#bdc3c7;cursor:not-allowed}
.card-counter{font-weight:600;color:#2c3e50}
.loading{text-align:center;padding:2rem;color:#7f8c8d;grid-column:1/-1}
.error-message{text-align:center;padding:2rem;color:#e74c3c;grid-column:1/-1}
.record-count{background:#fff;padding:1rem;border-radius:8px;text-align:center;font-weight:600;margin-bottom:1rem}
.price-tag{font-weight:700;color:#27ae60}
@media(max-width:768px){.filters{flex-direction:column}.filter-item{width:100%}.cards-container{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
    <header><h1>格鲁吉亚行程管理系统</h1><p class="subtitle">行程数据卡片展示</p></header>
    <div class="record-count" id="record-count">0条记录</div>

    <div class="filters">
        <div class="filter-item"><label>搜索单号/服务类型</label><input type="text" id="search" placeholder="输入单号或服务类型..."></div>
        <div class="filter-item"><label>开始日期</label><input type="date" id="date-from"></div>
        <div class="filter-item"><label>结束日期</label><input type="date" id="date-to"></div>
        <div class="filter-item">
            <label>导游类型</label>
            <select id="guide-type"><option value="">全部</option><option value="no">无需导游</option><option value="chinese">中文导游</option><option value="english">英文导游</option></select>
        </div>
        <div class="filter-item">
            <button class="btn" onclick="loadItineraries()"><i class="fas fa-search"></i> 搜索</button>
            <button class="btn btn-success" onclick="clearFilters()"><i class="fas fa-sync-alt"></i> 重置</button>
        </div>
    </div>

    <div class="cards-container" id="cards-container"><div class="loading"><i class="fas fa-spinner fa-spin"></i> 正在连接Supabase...</div></div>

    <div class="navigation">
        <button class="nav-btn" id="prev-btn" onclick="prevPage()" disabled><i class="fas fa-chevron-left"></i> 上一页</button>
        <div class="card-counter">第 <span id="current-page">1</span> 页 / 共 <span id="total-pages">1</span> 页</div>
        <button class="nav-btn" id="next-btn" onclick="nextPage()" disabled>下一页 <i class="fas fa-chevron-right"></i></button>
    </div>
</div>

<script>
/* ========== 工具：防抖 ========== */
function debounce(func, wait) {
    let timeout;
    return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

/* ========== 配置 ========== */
const SUPABASE_URL  = 'https://fezxhcmiefdbvqmhczut.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlenhoY21pZWZkYnZxbWhjenV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxNjE1MDYsImV4cCI6MjA3MjczNzUwNn0.MdXghSsixHXeYhZKbMYuJGehMUvdbtixGNjMmBPMKKU';

let supabase = null, itinerariesData = [], currentPage = 1, itemsPerPage = 6;

/* ========== 初始化 ========== */
async function initSupabase() {
    try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
        await supabase.from('itineraries').select('id').limit(1);
        console.log('Supabase 连接成功');
        return true;
    } catch (e) {
        console.error('Supabase 连接失败', e);
        showError('Supabase 连接失败: ' + e.message);
        return false;
    }
}

/* ========== 加载数据（排序固定） ========== */
async function loadItineraries() {
    if (!supabase && !await initSupabase()) return;
    showLoading('正在加载数据...');

    const search    = document.getElementById('search').value.trim();
    const dateFrom  = document.getElementById('date-from').value;
    const dateTo    = document.getElementById('date-to').value;
    const guideType = document.getElementById('guide-type').value;

    let q = supabase
        .from('itineraries')
        .select(`*,itinerary_days(*),passengers(*),extra_services(*)`)
        .order('start_date', { ascending: true })      // ① 日期升序
        .order('order_number', { ascending: true })


    if (search)    q = q.or(`order_number.ilike.%${search}%,service_type.ilike.%${search}%`);
    if (dateFrom)  q = q.gte('start_date', dateFrom);
    if (dateTo)    q = q.lte('end_date', dateTo);
    if (guideType) q = q.eq('guide_type', guideType);

    const { data, error } = await q;
    if (error) {
        if (error.code === 'PGRST301') { useMockData(); return; }
        showError('加载失败: ' + error.message); return;
    }

    itinerariesData = (data || []).map(it => ({
        ...it,
        start_date: it.start_date || '',
        end_date:   it.end_date   || '',
        itinerary_days: (it.itinerary_days || [])
            .map(d => ({ ...d, date: d.date || '' }))
            .sort((a, b) => a.day_number - b.day_number) // ✅ 按天数升序
    }));
    updateRecordCount();
    currentPage = 1;
    renderItineraryCards();
    updateNavigation();
}

/* ========== 小工具 ========== */
function safeDate(d) { return d || ''; }
function clearFilters() {
    ['search', 'date-from', 'date-to', 'guide-type'].forEach(id => document.getElementById(id).value = '');
    loadItineraries();
}
function updateRecordCount() {
    document.getElementById('record-count').textContent = `${itinerariesData.length} 条记录`;
}
function updateNavigation() {
    const total = Math.ceil(itinerariesData.length / itemsPerPage);
    document.getElementById('current-page').textContent = currentPage;
    document.getElementById('total-pages').textContent  = total;
    document.getElementById('prev-btn').disabled = currentPage <= 1;
    document.getElementById('next-btn').disabled = currentPage >= total;
}
function prevPage() {
    if (currentPage > 1) { currentPage--; renderItineraryCards(); updateNavigation(); }
}
function nextPage() {
    const total = Math.ceil(itinerariesData.length / itemsPerPage);
    if (currentPage < total) { currentPage++; renderItineraryCards(); updateNavigation(); }
}

/* ========== 渲染卡片 ========== */
function renderItineraryCards() {
    const start = (currentPage - 1) * itemsPerPage;
    const arr   = itinerariesData.slice(start, start + itemsPerPage);
    const html  = arr.map(it => `
        <div class="itinerary-card">
            <div class="order-number-section">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div><span class="order-number-label">单号:</span><span class="order-number-value">${it.order_number || '未分配'}</span></div>
                    <button class="copy-order-btn" onclick="copyToClipboard('${it.order_number || ''}')"><i class="fas fa-copy"></i> 复制</button>
                </div>
            </div>
            <div class="card-header"><h2 class="service-type">${it.service_type || '无服务类型'}</h2><span class="card-id">ID: ${it.id?.slice(0, 8) || 'N/A'}</span></div>
            <div class="card-section">
                <h3><i class="fas fa-info-circle"></i> 基本信息</h3>
                <div class="info-item"><span class="info-label">出行日期:</span><span>${it.start_date} - ${it.end_date}</span></div>
                <div class="info-item"><span class="info-label">航班号:</span><span>${it.flight_number || '无'}</span></div>
                <div class="info-item"><span class="info-label">抵达时间:</span><span>${it.arrival_time || '无'}</span></div>
                <div class="info-item"><span class="info-label">导游类型:</span><span>${{no: '无需导游', chinese: '中文导游', english: '英文导游'}[it.guide_type] || it.guide_type || '无'}</span></div>
                <div class="info-item"><span class="info-label">酒店标准:</span><span>${it.hotel_standard || '无'} - ${it.room_type || '无'}</span></div>
                <div class="info-item"><span class="info-label">总价格:</span><span class="price-tag">${it.total_price || '0'} USD</span></div>
            </div>
            <div class="card-section"><h3><i class="fas fa-calendar-alt"></i> 行程安排 (${it.itinerary_days?.length || 0} 天)</h3>
                ${it.itinerary_days?.length ? it.itinerary_days.map(d => `
                    <div class="day-item">
                        <div style="font-weight:600;color:#2c3e50">第${d.day_number}天 (${d.date})</div>
                        <div>${d.plan || '无行程安排'}</div>
                        <div>住宿: ${d.accommodation || '无'} (${d.accommodation_price || '0'} USD)</div>
                    </div>`).join('') : '<p>无行程安排</p>'}
            </div>
            <div class="card-section"><h3><i class="fas fa-users"></i> 乘客信息 (${it.passengers?.length || 0} 人)</h3>
                ${it.passengers?.length ? it.passengers.map(p => `
                    <div class="passenger-item"><span>${p.name || '无名'}</span><span>${p.country_code || ''} ${p.phone || '无电话'}</span></div>`).join('') : '<p>无乘客信息</p>'}
            </div>
            <div class="card-section"><h3><i class="fas fa-plus-circle"></i> 附加服务</h3>
                ${it.extra_services?.filter(s => s.is_selected).length ? it.extra_services.filter(s => s.is_selected).map(s => `
                    <div class="service-item"><span>${s.service_name || '无名称'}</span><span>${s.price || '0'} USD${s.unit || ''}</span></div>`).join('') : '<p>无附加服务</p>'}
            </div>
        </div>`).join('');
    document.getElementById('cards-container').innerHTML = html || '<div class="loading">当前页面无数据</div>';
}

/* ========== 其余小功能 ========== */
function copyToClipboard(text) {
    if (!text || text === '未分配') return;
    navigator.clipboard.writeText(text).then(() => showStatus('单号已复制'));
}
function showStatus(msg) {
    const s = document.createElement('div');
    s.style.cssText = 'position:fixed;top:20px;right:20px;background:#27ae60;color:#fff;padding:10px 20px;border-radius:5px;z-index:1000';
    s.textContent = msg;
    document.body.appendChild(s);
    setTimeout(() => document.body.removeChild(s), 2000);
}
function showLoading(msg) {
    document.getElementById('cards-container').innerHTML = `<div class="loading"><i class="fas fa-spinner fa-spin"></i> ${msg}</div>`;
}
function showError(msg) {
    document.getElementById('cards-container').innerHTML = `<div class="error-message"><i class="fas fa-exclamation-triangle"></i> ${msg}</div>`;
}

/* ========== 兜底模拟数据 ========== */
function useMockData() {
    itinerariesData = [
        { id: 'demo-001', order_number: 'ORD20240115001', service_type: '格鲁吉亚7日经典游', start_date: '2024-01-15', end_date: '2024-01-21', flight_number: 'CZ6039', guide_type: 'chinese', total_price: '1250', arrival_time: '14:30', hotel_standard: '四星级', room_type: '双人间', itinerary_days: [{ day_number: 1, date: '2024-01-15', plan: '抵达第比利斯，接机后入住酒店', accommodation: '第比利斯四星酒店', accommodation_price: '0' }, { day_number: 2, date: '2024-01-16', plan: '第比利斯城市观光', accommodation: '第比利斯四星酒店', accommodation_price: '0' }], passengers: [{ name: '张先生', country_code: '+86', phone: '13800138000' }, { name: '李女士', country_code: '+86', phone: '13900139000' }], extra_services: [{ service_name: '机场接送', price: '40', is_selected: true }, { service_name: '酒庄品酒', price: '30', is_selected: true }] },
        { id: 'demo-002', order_number: 'ORD20240120002', service_type: '格鲁吉亚5日精华游', start_date: '2024-01-20', end_date: '2024-01-24', flight_number: 'TK1234', guide_type: 'english', total_price: '980', arrival_time: '16:45', hotel_standard: '五星级', room_type: '大床房', itinerary_days: [{ day_number: 1, date: '2024-01-20', plan: '抵达第比利斯，自由活动', accommodation: '第比利斯五星酒店', accommodation_price: '0' }], passengers: [{ name: 'John Smith', country_code: '+1', phone: '5551234567' }], extra_services: [{ service_name: '景点门票', price: '80', is_selected: true }] }
    ].map(it => ({ ...it, start_date: it.start_date || '', end_date: it.end_date || '', itinerary_days: it.itinerary_days.map(d => ({ ...d, date: d.date || '' })) }));
    updateRecordCount();
    currentPage = 1;
    renderItineraryCards();
    updateNavigation();
}

/* ========== 事件绑定 ========== */
document.addEventListener('DOMContentLoaded', () => {
    ['date-from', 'date-to', 'guide-type'].forEach(id => document.getElementById(id).addEventListener('change', loadItineraries));
    document.getElementById('search').addEventListener('input', debounce(loadItineraries, 500));
    loadItineraries();
});
</script>

</body>
</html>
