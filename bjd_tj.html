<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>æ ¼é²å‰äºšç»Ÿè®¡</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root{--bg:#f5f7fa;--fg:#333;--card:#fff;--primary:#3498db;--shadow:0 2px 8px rgba(0,0,0,.08);}
    [data-theme="dark"]{--bg:#121212;--fg:#e0e0e0;--card:#1e1e1e;--primary:#4dabf7;--shadow:0 2px 8px rgba(0,0,0,.35);}
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    body{background:var(--bg);color:var(--fg);padding:20px;transition:background .3s,color .3s}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1.2rem}
    .card{background:var(--card);border-radius:12px;padding:1.2rem;box-shadow:var(--shadow)}
    .num{font-size:2rem;font-weight:700;color:var(--primary)}
    .label{font-size:.9rem;opacity:.8}
    .col-2{grid-column:span 2}
    .col-3{grid-column:span 3}
    canvas{max-height:280px}
    .btn{background:var(--primary);color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:.9rem}
    .btn:hover{opacity:.9}
    @media(max-width:600px){.col-2,.col-3{grid-column:span 1}}
  </style>
</head>
<body>
  <header>
    <h1>æ ¼é²å‰äºšçº¯è§†è§‰ç»Ÿè®¡</h1>
    <div>
      <button class="btn" onclick="toggleTheme()">ğŸŒ— åˆ‡æ¢ä¸»é¢˜</button>
      <button class="btn" onclick="exportExcel()">ğŸ“Š å¯¼å‡º Excel</button>
      <button class="btn" onclick="sharePNG()">ğŸ“¸ ç”Ÿæˆé•¿å›¾</button>
    </div>
  </header>

  <main class="grid">
    <!-- æŒ‡æ ‡ -->
    <section class="card"><div class="num" id="total-orders">-</div><div class="label">è®¢å•æ€»æ•°</div></section>
    <section class="card"><div class="num" id="total-sales">-</div><div class="label">é”€å”®æ€»é¢ï¼ˆUSDï¼‰</div></section>
    <section class="card"><div class="num" id="avg-price">-</div><div class="label">å®¢å•ä»·ï¼ˆUSDï¼‰</div></section>
    <section class="card"><div class="num" id="total-guests">-</div><div class="label">æ¥å¾…äººæ•°</div></section>

    <!-- å›¾è¡¨ -->
    <section class="card col-2"><canvas id="status-chart"></canvas></section>
    <section class="card col-2"><canvas id="guide-chart"></canvas></section>
    <section class="card col-2"><canvas id="sales-trend"></canvas></section>
    <section class="card col-2"><canvas id="price-dist"></canvas></section>
    <section class="card col-2"><canvas id="daily-orders"></canvas></section>
    <section class="card col-2"><canvas id="daily-avg-per-guest"></canvas></section>
    <section class="card col-3"><canvas id="heatmap-chart"></canvas></section>
    <section class="card col-2"><canvas id="scatter-price-pax"></canvas></section>
  </main>

  <script>
    /* ========== é…ç½® ========== */
    const SUPABASE_URL  = 'https://fezxhcmiefdbvqmhczut.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlenhoY21pZWZkYnZxbWhjenV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxNjE1MDYsImV4cCI6MjA3MjczNzUwNn0.MdXghSsixHXeYhZKbMYuJGehMUvdbtixGNjMmBPMKKU';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    const $ = id => document.getElementById(id);
    let globalList = [];

    /* ========== æ‹‰æ•°æ®ï¼ˆä»…æ•°å­—/æšä¸¾ï¼‰ ========== */
    async function fetchData() {
      const { data, error } = await sb
        .from('itineraries')
        .select(`id, order_number, total_price, guide_type, start_date, end_date, passengers(name)`);
      if (error) { alert('è¯»å–å¤±è´¥ï¼š' + error.message); return []; }
      return data;
    }

    /* ========== æŒ‡æ ‡ ========== */
    function calcMetrics(list) {
      const totalOrders = list.length;
      const totalSales = list.reduce((s, it) => s + (+it.total_price || 0), 0);
      const avgPrice = totalOrders ? (totalSales / totalOrders).toFixed(0) : 0;
      const totalGuests = list.reduce((s, it) => s + (it.passengers?.length || 0), 0);
      $('total-orders').textContent = totalOrders;
      $('total-sales').textContent = totalSales.toLocaleString();
      $('avg-price').textContent = avgPrice;
      $('total-guests').textContent = totalGuests;
    }

    /* ========== ç”»å›¾ ========== */
    function drawCharts(list) {
      /* çŠ¶æ€åˆ†å¸ƒ */
      const status = { æœªå¼€å§‹: 0, è¿›è¡Œä¸­: 0, å·²ç»“æŸ: 0 };
      const today = new Date();
      list.forEach(it => {
        const s = new Date(it.start_date), e = new Date(it.end_date);
        if (today < s) status['æœªå¼€å§‹']++; else if (today > e) status['å·²ç»“æŸ']++; else status['è¿›è¡Œä¸­']++;
      });
      new Chart($('status-chart'), { type: 'doughnut', data: { labels: Object.keys(status), datasets: [{ data: Object.values(status), backgroundColor: ['#f39c12', '#27ae60', '#e74c3c'] }] }, options: { plugins: { title: { display: true, text: 'è®¢å•çŠ¶æ€åˆ†å¸ƒ' } } } });

      /* å¯¼æ¸¸ç±»å‹ */
      const guide = { æ— éœ€å¯¼æ¸¸: 0, ä¸­æ–‡å¯¼æ¸¸: 0, è‹±æ–‡å¯¼æ¸¸: 0 };
      list.forEach(it => { guide[{ no: 'æ— éœ€å¯¼æ¸¸', chinese: 'ä¸­æ–‡å¯¼æ¸¸', english: 'è‹±æ–‡å¯¼æ¸¸' }[it.guide_type] || 'æ— éœ€å¯¼æ¸¸']++; });
      new Chart($('guide-chart'), { type: 'pie', data: { labels: Object.keys(guide), datasets: [{ data: Object.values(guide), backgroundColor: ['#95a5a6', '#3498db', '#2ecc71'] }] }, options: { plugins: { title: { display: true, text: 'å¯¼æ¸¸ç±»å‹å æ¯”' } } } });

      /* æœˆåº¦é”€å”®è¶‹åŠ¿ */
      const monthSales = {};
      list.forEach(it => { const m = it.start_date.substring(0, 7); monthSales[m] = (monthSales[m] || 0) + (+it.total_price || 0); });
      const months = Object.keys(monthSales).sort();
      new Chart($('sales-trend'), { type: 'line', data: { labels: months, datasets: [{ label: 'é”€å”®é¢ (USD)', data: months.map(m => monthSales[m]), borderColor: '#3498db', tension: .3 }] }, options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } } });

      /* ä»·æ ¼åŒºé—´ */
      const ranges = { '<500': 0, '500-999': 0, '1000-1999': 0, 'â‰¥2000': 0 };
      list.forEach(it => { const p = +it.total_price || 0; if (p < 500) ranges['<500']++; else if (p < 1000) ranges['500-999']++; else if (p < 2000) ranges['1000-1999']++; else ranges['â‰¥2000']++; });
      new Chart($('price-dist'), { type: 'bar', data: { labels: Object.keys(ranges), datasets: [{ label: 'è®¢å•æ•°', data: Object.values(ranges), backgroundColor: '#1abc9c' }] }, options: { plugins: { legend: { display: false }, title: { display: true, text: 'è®¢å•ä»·æ ¼åˆ†å¸ƒ' } } } });

      /* æ¯æ—¥è®¢å•æ•° */
      const dailyCount = {};
      list.forEach(it => { const d = it.start_date; dailyCount[d] = (dailyCount[d] || 0) + 1; });
      const days = Object.keys(dailyCount).sort();
      new Chart($('daily-orders'), { type: 'line', data: { labels: days, datasets: [{ label: 'è®¢å•æ•°', data: days.map(d => dailyCount[d]), borderColor: '#e67e22', tension: .3 }] }, options: { plugins: { title: { display: true, text: 'æ¯æ—¥è®¢å•æ•°' } }, scales: { y: { beginAtZero: true } } } });

      /* æ¯æ—¥äººå‡æ¶ˆè´¹ */
      const dailyPrice = {}, dailyPax = {};
      list.forEach(it => { const d = it.start_date, p = +it.total_price || 0, n = it.passengers?.length || 0; dailyPrice[d] = (dailyPrice[d] || 0) + p; dailyPax[d] = (dailyPax[d] || 0) + n; });
      const days2 = Object.keys(dailyPrice).sort();
      const avgPerGuest = days2.map(d => (dailyPax[d] ? (dailyPrice[d] / dailyPax[d]).toFixed(0) : 0));
      new Chart($('daily-avg-per-guest'), { type: 'line', data: { labels: days2, datasets: [{ label: 'äººå‡æ¶ˆè´¹ (USD)', data: avgPerGuest, borderColor: '#8e44ad', tension: .3 }] }, options: { plugins: { title: { display: true, text: 'æ¯æ—¥äººå‡æ¶ˆè´¹' } }, scales: { y: { beginAtZero: true } } } });

      /* å¯¼æ¸¸æ—¥å†çƒ­åŠ›å›¾ï¼ˆæŒ‰æœˆï¼‰ */
      const heat = {};
      list.forEach(it => {
        const d = new Date(it.start_date);
        const ym = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        heat[ym] = (heat[ym] || 0) + 1;
      });
      const labels = Object.keys(heat).sort();
      const data = labels.map(l => heat[l]);
      new Chart($('heatmap-chart'), { type: 'bar', data: { labels: labels, datasets: [{ label: 'è®¢å•æ•°', data: data, backgroundColor: '#27ae60' }] }, options: { plugins: { title: { display: true, text: 'å¯¼æ¸¸æ—¥å†çƒ­åŠ›å›¾ï¼ˆæŒ‰æœˆï¼‰' } } } });

      /* ä»·æ ¼-äººæ•°æ•£ç‚¹å›¾ */
      const scatter = [];
      list.forEach(it => { const n = it.passengers?.length || 0, p = +it.total_price || 0; if (n > 0) scatter.push({ x: n, y: p }); });
      new Chart($('scatter-price-pax'), { type: 'scatter', data: { datasets: [{ label: 'è®¢å•', data: scatter, backgroundColor: '#3498db' }] }, options: { plugins: { title: { display: true, text: 'ä»·æ ¼-äººæ•°å…³ç³»' } }, scales: { x: { title: { display: true, text: 'äººæ•°' } }, y: { title: { display: true, text: 'ä»·æ ¼ (USD)' } } } } });
    }

    /* ========== å·¥å…·å‡½æ•° ========== */
    function toggleTheme() {
      const html = document.documentElement;
      html.setAttribute('data-theme', html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
    }
    function exportExcel() {
      const ws = XLSX.utils.json_to_sheet(globalList.map(it => ({
        è®¢å•å·: it.order_number,
        æ€»ä»·: it.total_price,
        å¯¼æ¸¸: it.guide_type,
        å¼€å§‹æ—¥æœŸ: it.start_date,
        ç»“æŸæ—¥æœŸ: it.end_date,
        äººæ•°: it.passengers?.length || 0
      })));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'è®¢å•');
      XLSX.writeFile(wb, 'æ ¼é²å‰äºšè®¢å•_' + new Date().toLocaleDateString() + '.xlsx');
    }
    async function sharePNG() {
      const canvas = await html2canvas(document.querySelector('main'));
      const link = document.createElement('a');
      link.download = 'æ ¼é²å‰äºšç»Ÿè®¡é•¿å›¾_' + new Date().toLocaleDateString() + '.png';
      link.href = canvas.toDataURL();
      link.click();
    }

    /* ========== å¯åŠ¨ ========== */
    async function run() {
      globalList = await fetchData();
      calcMetrics(globalList);
      drawCharts(globalList);
    }
    run();
  </script>
</body>
</html>
