<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>格鲁吉亚行程统计</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#f5f7fa;
      --fg:#333;
      --card:#fff;
      --primary:#3498db;
      --shadow:0 2px 8px rgba(0,0,0,.08);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#121212;
        --fg:#e0e0e0;
        --card:#1e1e1e;
        --primary:#4dabf7;
        --shadow:0 2px 8px rgba(0,0,0,.35);
      }
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    body{background:var(--bg);color:var(--fg);padding:20px;transition:background .3s,color .3s}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1.2rem}
    .card{background:var(--card);border-radius:12px;padding:1.2rem;box-shadow:var(--shadow)}
    .num{font-size:2rem;font-weight:700;color:var(--primary)}
    .label{font-size:.9rem;opacity:.8}
    .col-2{grid-column:span 2}
    canvas{max-height:280px}
    @media(max-width:600px){.col-2{grid-column:span 1}}
  </style>
</head>
<body>
  <header>
    <h1>格鲁吉亚行程统计</h1>
  </header>

  <main class="grid">
    <section class="card"><div class="num" id="total-orders">-</div><div class="label">订单总数</div></section>
    <section class="card"><div class="num" id="total-sales">-</div><div class="label">销售总额（USD）</div></section>
    <section class="card"><div class="num" id="avg-price">-</div><div class="label">客单价（USD）</div></section>
    <section class="card"><div class="num" id="total-guests">-</div><div class="label">接待人数</div></section>

    <section class="card col-2"><canvas id="status-chart"></canvas></section>
    <section class="card col-2"><canvas id="guide-chart"></canvas></section>
    <section class="card col-2"><canvas id="sales-trend"></canvas></section>
    <section class="card col-2"><canvas id="price-dist"></canvas></section>
  </main>

  <script>
    /* ========== 配置 ========== */
    const SUPABASE_URL  = 'https://fezxhcmiefdbvqmhczut.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlenhoY21pZWZkYnZxbWhjenV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxNjE1MDYsImV4cCI6MjA3MjczNzUwNn0.MdXghSsixHXeYhZKbMYuJGehMUvdbtixGNjMmBPMKKU';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    /* ========== 工具函数 ========== */
    const $ = id => document.getElementById(id);
    const chartFont = { family: 'Segoe UI', size: 12 };

    /* ========== 1. 拉数据 ========== */
    async function fetchData() {
      const { data, error } = await sb
        .from('itineraries')
        .select(`id, order_number, total_price, guide_type, start_date, end_date, passengers(name)`);
      if (error) { alert('读取失败：' + error.message); return []; }
      return data;
    }

    /* ========== 2. 计算指标 ========== */
    function calcMetrics(list) {
      const totalOrders = list.length;
      const totalSales = list.reduce((s, it) => s + (+it.total_price || 0), 0);
      const avgPrice = totalOrders ? (totalSales / totalOrders).toFixed(0) : 0;
      const totalGuests = list.reduce((s, it) => s + (it.passengers?.length || 0), 0);
      $('total-orders').textContent = totalOrders;
      $('total-sales').textContent = totalSales.toLocaleString();
      $('avg-price').textContent = avgPrice;
      $('total-guests').textContent = totalGuests;
      return { totalOrders, totalSales, avgPrice, totalGuests };
    }

    /* ========== 3. 画图 ========== */
    function drawCharts(list) {
      const statusCtx = $('status-chart').getContext('2d');
      const guideCtx  = $('guide-chart').getContext('2d');
      const salesCtx  = $('sales-trend').getContext('2d');
      const priceCtx  = $('price-dist').getContext('2d');

      /* 状态分布 */
      const status = { 未开始: 0, 进行中: 0, 已结束: 0 };
      const today = new Date();
      list.forEach(it => {
        const s = new Date(it.start_date), e = new Date(it.end_date);
        if (today < s) status['未开始']++;
        else if (today > e) status['已结束']++;
        else status['进行中']++;
      });
      new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(status),
          datasets: [{ data: Object.values(status), backgroundColor: ['#f39c12', '#27ae60', '#e74c3c'] }]
        },
        options: { plugins: { legend: { position: 'bottom' }, title: { display: true, text: '订单状态分布' } } }
      });

      /* 导游类型 */
      const guide = { 无需导游: 0, 中文导游: 0, 英文导游: 0 };
      list.forEach(it => { guide[{ no: '无需导游', chinese: '中文导游', english: '英文导游' }[it.guide_type] || '无需导游']++; });
      new Chart(guideCtx, {
        type: 'pie',
        data: {
          labels: Object.keys(guide),
          datasets: [{ data: Object.values(guide), backgroundColor: ['#95a5a6', '#3498db', '#2ecc71'] }]
        },
        options: { plugins: { legend: { position: 'bottom' }, title: { display: true, text: '导游类型占比' } } }
      });

      /* 月度销售趋势 */
      const monthSales = {};
      list.forEach(it => {
        const m = it.start_date.substring(0, 7); // yyyy-mm
        monthSales[m] = (monthSales[m] || 0) + (+it.total_price || 0);
      });
      const months = Object.keys(monthSales).sort();
      new Chart(salesCtx, {
        type: 'line',
        data: {
          labels: months,
          datasets: [{ label: '销售额 (USD)', data: months.map(m => monthSales[m]), borderColor: '#3498db', tension: .3 }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });

      /* 价格区间 */
      const ranges = { '<500': 0, '500-999': 0, '1000-1999': 0, '≥2000': 0 };
      list.forEach(it => {
        const p = +it.total_price || 0;
        if (p < 500) ranges['<500']++;
        else if (p < 1000) ranges['500-999']++;
        else if (p < 2000) ranges['1000-1999']++;
        else ranges['≥2000']++;
      });
      new Chart(priceCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(ranges),
          datasets: [{ label: '订单数', data: Object.values(ranges), backgroundColor: '#1abc9c' }]
        },
        options: { plugins: { legend: { display: false }, title: { display: true, text: '订单价格分布' } } }
      });
    }

    /* ========== 4. 运行流程 ========== */
    async function run() {
      const list = await fetchData();
      const metrics = calcMetrics(list);
      drawCharts(list);
    }
    run();
  </script>
</body>
</html>
