<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡é£æ ¼èŠå¤©å®¤</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="styles.css">
    <!-- ç¿»è¯‘å¼•æ“ -->
    <script src="translator.js"></script>
    <!-- è¢«è¸¢å‡ºæˆ¿é—´å®æ—¶ç›‘å¬ï¼ˆå†…ç½®ç‰ˆï¼‰ -->
    <script>
	
// è¢«è¸¢å‡ºæˆ¿é—´çš„å®æ—¶ç›‘å¬
document.addEventListener('DOMContentLoaded', () => {
    const waitForChatManager = setInterval(() => {
        if (window.chatManager && window.chatManager.currentUser && window.chatManager.supabase) {
            clearInterval(waitForChatManager);
            startKickListener();
        }
    }, 300);

    function startKickListener() {
        const cm = window.chatManager;
        const userId = cm.currentUser.userId;

        // ç›‘å¬æˆå‘˜è¡¨åˆ é™¤äº‹ä»¶ï¼ˆè¢«è¸¢ï¼‰
        cm.supabase
            .channel('kick_listener_' + userId)
            .on('postgres_changes', {
                event: 'DELETE',
                schema: 'public',
                table: 'room_members',
                filter: `user_id=eq.${userId}`
            }, (payload) => {
                // å¦‚æœè¢«è¸¢çš„æ˜¯å½“å‰æˆ¿é—´
                if (payload.old.room_id === cm.currentRoom?.id) {
                    handleKickedFromRoom(cm, payload.old.room_id);
                }
            })
            .subscribe();

        // ç›‘å¬æˆå‘˜çŠ¶æ€æ›´æ–°äº‹ä»¶ï¼ˆæ ‡è®°ä¸ºè¢«è¸¢ï¼‰
        cm.supabase
            .channel('kick_status_listener_' + userId)
            .on('postgres_changes', {
                event: 'UPDATE',
                schema: 'public',
                table: 'room_members',
                filter: `user_id=eq.${userId}`
            }, (payload) => {
                if (payload.new.status === 'kicked' && payload.new.room_id === cm.currentRoom?.id) {
                    handleKickedFromRoom(cm, payload.new.room_id);
                }
            })
            .subscribe();
    }

    function handleKickedFromRoom(chatManager, roomId) {
        // ç«‹å³ç¦ç”¨èŠå¤©åŠŸèƒ½
        const input = document.getElementById('messageInput');
        const btn = document.getElementById('sendBtn');
        if (input) input.disabled = true;
        if (btn) btn.disabled = true;
        
        // æ˜¾ç¤ºè¢«è¸¢æç¤º
        chatManager.showError('æ‚¨å·²è¢«ç§»å‡ºè¯¥ç¾¤èŠï¼Œæ— æ³•å‘é€æ¶ˆæ¯å’ŒæŸ¥çœ‹æ–°æ¶ˆæ¯');
        
        // æ¸…ç©ºå½“å‰æˆ¿é—´
        chatManager.currentRoom = null;
        
        // åˆ·æ–°æˆ¿é—´åˆ—è¡¨ï¼ˆè¢«è¸¢çš„æˆ¿é—´ä¼šæ¶ˆå¤±ï¼‰
        setTimeout(() => {
            chatManager.loadRooms();
            chatManager.showChatList();
        }, 2000);
    }
});
</script>


<script>
document.addEventListener('DOMContentLoaded', () => {
  // ç­‰å¾… ChatManager åˆå§‹åŒ–å®Œæˆ
  const waitForChatManager = setInterval(() => {
    if (window.chatManager && window.chatManager.currentUser && window.chatManager.supabase) {
      clearInterval(waitForChatManager);
      startKickListener();
    }
  }, 300);

  function startKickListener() {
    const cm = window.chatManager;
    const userId = cm.currentUser.userId;

    cm.supabase
      .channel('kick_check_' + userId)
      .on('postgres_changes', {
        event: 'DELETE',
        schema: 'public',
        table: 'room_members',
        filter: `user_id=eq.${userId}`
      }, (payload) => {
        // ç¡®ä¿è¢«è¸¢çš„æ˜¯å½“å‰æˆ¿é—´
        if (payload.old.room_id === cm.currentRoom?.id) {
          alert('æ‚¨å·²è¢«è¸¢å‡ºæˆ¿é—´');
          cm.currentRoom = null;
          cm.loadRooms();          // åˆ·æ–°æˆ¿é—´åˆ—è¡¨
          cm.showChatList();       // å¼ºåˆ¶å›åˆ°åˆ—è¡¨é¡µ
        }
      })
      .subscribe();
  }
});
</script>

</head>
<body>
    <!-- å·¦ä¾§è¾¹æ  -->
    <div class="sidebar">
        <div class="sidebar-item active" id="chatTab">ğŸ’¬ğŸ’¬</div>
        <div class="sidebar-item" id="contactsTab">ğŸ‘¥ğŸ‘¥</div>
        <div class="sidebar-item" id="discoverTab">ğŸ”ğŸ”</div>
        <div class="sidebar-item" id="settingsTab">âš™âš™ï¸</div>
    </div>
    
    <!-- èŠå¤©åˆ—è¡¨ -->
    <div class="chat-list" id="chatList">
        <div class="search-bar">
            <input type="text" id="chatSearch" placeholder="æœç´¢èŠå¤©">
        </div>
        <div class="chat-items" id="chatItems">
            <div class="welcome-message">åŠ è½½ä¸­...</div>
        </div>
    </div>
    
    <!-- é€šè®¯å½• -->
    <div class="contacts-container" id="contactsContainer">
        <div class="search-bar">
            <input type="text" id="contactSearch" placeholder="æœç´¢è”ç³»äºº">
        </div>
        <div class="chat-items" id="contactsList">
            <div class="welcome-message">åŠ è½½ä¸­...</div>
        </div>
    </div>
    
    <!-- å‘ç°é¡µé¢ -->
    <div class="contacts-container" id="discoverContainer">
        <div class="setting-item">
            <div><span class="setting-icon">ğŸ”„ğŸ”„</span>æœ‹å‹åœˆ</div>
            <span class="setting-arrow">â€º</span>
        </div>
        <div class="setting-item">
            <div><span class="setting-icon">ğŸ”ğŸ”</span>æ‰«ä¸€æ‰«</div>
            <span class="setting-arrow">â€º</span>
        </div>
        <div class="setting-item">
            <div><span class="setting-icon">ğŸ‘‹ğŸ‘‹</span>æ‘‡ä¸€æ‘‡</div>
            <span class="setting-arrow">â€º</span>
        </div>
        <div class="setting-item">
            <div><span class="setting-icon">ğŸ‘€ğŸ‘€</span>çœ‹ä¸€çœ‹</div>
            <span class="setting-arrow">â€º</span>
        </div>
        <div class="setting-item">
            <div><span class="setting-icon">ğŸ”ğŸ”</span>æœä¸€æœ</div>
            <span class="setting-arrow">â€º</span>
        </div>
    </div>
    
    <!-- è®¾ç½®é¡µé¢ -->
    <div class="settings-container" id="settingsContainer">
        <div class="setting-item" id="changeNameBtn">
            <div><span class="setting-icon">ğŸ‘¤ğŸ‘¤</span>ä¿®æ”¹ç”¨æˆ·å</div>
            <span class="setting-arrow">â€º</span>
        </div>
        <div class="setting-item" id="privacySettingsBtn">
            <div><span class="setting-icon">ğŸ”’ğŸ”’</span>éšç§è®¾ç½®</div>
            <span class="setting-arrow">â€º</span>
        </div>
        <div class="setting-item" id="notificationSettingsBtn">
            <div><span class="setting-icon">ğŸ””ğŸ””</span>é€šçŸ¥è®¾ç½®</div>
            <span class="setting-arrow">â€º</span>
        </div>
        <div class="setting-item" id="aboutBtn">
            <div><span class="setting-icon">â„¹â„¹ï¸</span>å…³äºæˆ‘ä»¬</div>
            <span class="setting-arrow">â€º</span>
        </div>
        <div class="setting-item" id="logoutBtn">
            <div><span class="setting-icon">ğŸšªğŸšª</span>é€€å‡ºç™»å½•</div>
            <span class="setting-arrow">â€º</span>
        </div>
    </div>
    
    <!-- èŠå¤©åŒºåŸŸ -->
    <div class="chat-area" id="chatArea">
        <div class="chat-header">
            <div style="margin-left:auto;display:flex;align-items:center;gap:6px;">
                <span style="font-size:12px;color:#666">è‡ªåŠ¨ç¿»è¯‘</span>
                <label class="switch">
                    <input type="checkbox" id="autoTransToggle">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="chat-title" id="roomTitle">å¾®ä¿¡é£æ ¼èŠå¤©å®¤</div>
            <div class="chat-actions">
                <div class="chat-action" id="createRoomBtn">æ–°å»ºæˆ¿é—´</div>
                <div class="chat-action" id="roomMembersBtn">æˆå‘˜</div>
                <div class="chat-action" id="roomSettingsBtn">è®¾ç½®</div>
            </div>
        </div>
        
        <div class="messages-container" id="messagesContainer">
            <div class="welcome-message">æ¬¢è¿ä½¿ç”¨å¾®ä¿¡é£æ ¼èŠå¤©å®¤ï¼è¯·é€‰æ‹©å·¦ä¾§èŠå¤©å®¤å¼€å§‹èŠå¤©</div>
        </div>
        
        <div class="input-area">
            <div class="input-tools">
                <button class="tool-btn" id="emojiBtn" title="è¡¨æƒ…">ğŸ˜ŠğŸ˜Š</button>
                <button class="tool-btn" id="voiceBtn" title="è¯­éŸ³æ¶ˆæ¯">ğŸ¤ğŸ¤</button>
                <button class="tool-btn" id="fileBtn" title="æ–‡ä»¶">ğŸ“ğŸ“</button>
                <button class="tool-btn" id="imageBtn" title="å›¾ç‰‡">ğŸ–¼ğŸ–¼ğŸ–¼ï¸</button>
                <button class="tool-btn" id="cameraBtn" title="æ‹ç…§">ğŸ“·ğŸ“·</button>
                <button class="tool-btn" id="videoBtn" title="è§†é¢‘å½•åˆ¶">ğŸ“¹ğŸ“¹</button>
            </div>
            <textarea class="message-input" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." disabled></textarea>
            <button class="send-btn" id="sendBtn" disabled>å‘é€</button>
        </div>
    </div>
    
    <!-- æ¨¡æ€æ¡† -->
    <div class="modal" id="createRoomModal">
        <div class="modal-content">
            <div class="modal-title">æ–°å»ºèŠå¤©å®¤</div>
            <input type="text" class="modal-input" id="roomNameInput" placeholder="æˆ¿é—´åç§°ï¼ˆå¿…å¡«ï¼‰">
            <textarea class="modal-input" id="roomDescInput" placeholder="æˆ¿é—´æè¿°ï¼ˆå¯é€‰ï¼‰" rows="3"></textarea>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="cancelCreateRoom">å–æ¶ˆ</button>
                <button class="modal-btn primary" id="confirmCreateRoom">åˆ›å»º</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="changeNameModal">
        <div class="modal-content">
            <div class="modal-title">ä¿®æ”¹ç”¨æˆ·å</div>
            <input type="text" class="modal-input" id="newNameInput" placeholder="è¾“å…¥æ–°ç”¨æˆ·å">
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="cancelChangeName">å–æ¶ˆ</button>
                <button class="modal-btn primary" id="confirmChangeName">ç¡®è®¤</button>
            </div>
        </div>
    </div>
    
    <!-- æˆå‘˜ç®¡ç†æ¨¡æ€æ¡† -->
    <div class="modal" id="roomMembersModal">
        <div class="modal-content">
            <div class="modal-title">æˆ¿é—´æˆå‘˜ç®¡ç†</div>
            <div class="members-list" id="membersList">
                <!-- æˆå‘˜åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="closeMembersModal">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <!-- æˆ¿é—´è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="roomSettingsModal">
        <div class="modal-content">
            <div class="modal-title">æˆ¿é—´è®¾ç½®</div>
            <div class="setting-option">
            <button class="modal-btn danger" id="deleteRoomBtn" style="display:none;">åˆ é™¤æˆ¿é—´</button>

                <label>æˆ¿é—´åç§°:</label>
                <input type="text" class="modal-input" id="editRoomName" placeholder="æ–°æˆ¿é—´åç§°">
            </div>
            <div class="setting-option">
                <label>æˆ¿é—´æè¿°:</label>
                <textarea class="modal-input" id="editRoomDesc" placeholder="æ–°æˆ¿é—´æè¿°" rows="2"></textarea>
            </div>
            <div class="setting-option">
                <label>æˆ¿é—´æƒé™:</label>
                <select class="modal-input" id="roomPermission">
                    <option value="public">å…¬å¼€æˆ¿é—´</option>
                    <option value="private">ç§æœ‰æˆ¿é—´</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="closeRoomSettings">å–æ¶ˆ</button>
                <button class="modal-btn primary" id="saveRoomSettings">ä¿å­˜è®¾ç½®</button>
                <button class="modal-btn danger" id="deleteRoomBtn" style="display:none;">åˆ é™¤æˆ¿é—´</button>
            </div>
        </div>
    </div>
    
    <!-- æˆå‘˜æ“ä½œèœå• -->
    <div class="modal" id="memberActionsModal">
        <div class="modal-content">
            <div class="modal-title" id="memberActionsTitle">æˆå‘˜æ“ä½œ</div>
            <div class="member-actions" id="memberActionsList">
                <!-- æ“ä½œæŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="closeMemberActions">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- æ‹ç…§é¢„è§ˆ -->
    <div class="camera-preview" id="cameraPreview">
        <video class="camera-video" id="cameraLive" autoplay></video>
        <div class="camera-controls">
            <button class="camera-btn" id="closeCameraBtn" title="å…³é—­">âœ•âœ•</button>
            <button class="camera-btn camera-capture" id="captureBtn" title="æ‹ç…§">ğŸ“¸ğŸ“¸</button>
            <button class="camera-btn" id="switchCameraBtn" title="åˆ‡æ¢æ‘„åƒå¤´">ğŸ”„ğŸ”„</button>
        </div>
    </div>

    <!-- å¼•å…¥æ¨¡å—åŒ–JSæ–‡ä»¶ -->
    <script src="config.js"></script>
    <script src="chat-manager.js"></script>
    
    <style>
        /* æˆå‘˜ç®¡ç†ç›¸å…³æ ·å¼ */
        .members-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .member-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .member-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #07c160;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .member-details {
            display: flex;
            flex-direction: column;
        }
        
        .member-name {
            font-weight: 500;
        }
        
        .member-role {
            font-size: 12px;
            color: #666;
        }
        
        .member-actions {
            display: flex;
            gap: 5px;
        }
        
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .action-btn.kick {
            background: #ff4757;
            color: white;
        }
        
        .action-btn.promote {
            background: #007acc;
            color: white;
        }
        
        .action-btn.demote {
            background: #ffa502;
            color: white;
        }
        
        .setting-option {
            margin-bottom: 15px;
        }
        
        .setting-option label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .modal-btn.danger {
            background: #ff4757;
            color: white;
        }
        
        .modal-btn.danger:hover {
            background: #ff3742;
        }
        
        .role-owner {
            color: #ff4757;
            font-weight: bold;
        }
        
        .role-admin {
            color: #007acc;
            font-weight: bold;
        }
        
        .role-member {
            color: #666;
        }
    </style>
    <!-- æˆå‘˜ç®¡ç†æ¨¡æ€æ¡† -->
<div class="modal" id="roomMembersModal">
    <div class="modal-content">
        <div class="modal-title">æˆ¿é—´æˆå‘˜ç®¡ç†</div>
        <div class="members-list" id="membersList">
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <span>åŠ è½½ä¸­...</span>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn secondary" id="closeMembersModal">å…³é—­</button>
        </div>
    </div>
</div>

<!-- æˆ¿é—´è®¾ç½®æ¨¡æ€æ¡† -->
<div class="modal" id="roomSettingsModal">
    <div class="modal-content">
        <div class="modal-title">æˆ¿é—´è®¾ç½®</div>
        <div class="setting-option">
            <label>æˆ¿é—´åç§°:</label>
            <input type="text" class="modal-input" id="editRoomName" placeholder="æ–°æˆ¿é—´åç§°">
        </div>
        <div class="setting-option">
            <label>æˆ¿é—´æè¿°:</label>
            <textarea class="modal-input" id="editRoomDesc" placeholder="æ–°æˆ¿é—´æè¿°" rows="2"></textarea>
        </div>
        <div class="setting-option">
            <label>æˆ¿é—´æƒé™:</label>
            <select class="modal-input" id="roomPermission">
                <option value="public">å…¬å¼€æˆ¿é—´</option>
                <option value="private">ç§æœ‰æˆ¿é—´</option>
            </select>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn secondary" id="closeRoomSettings">å–æ¶ˆ</button>
            <button class="modal-btn primary" id="saveRoomSettings">ä¿å­˜è®¾ç½®</button>
            <button class="modal-btn danger" id="deleteRoomBtn" style="display:none;">åˆ é™¤æˆ¿é—´</button>
        </div>
    </div>
</div>
</body>
</html>