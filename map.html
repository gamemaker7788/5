<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <title>全部行程地图</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html,body{margin:0;height:100%;font-family:"Segoe UI",sans-serif;background:#f5f7fa;}
    #map{height:100%;width:100%;}
    .ui-bar{position:absolute;top:9px;left:10px;z-index:999;background:#fff;padding:8px 12px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.2);display:flex;gap:8px;}
    .ui-bar button{padding:6px 12px;border:none;border-radius:4px;background:#1976d2;color:#fff;cursor:pointer;}
  </style>
</head>
<body>
<div class="ui-bar">
  <button onclick="loadAllItineraryDays()">刷新全部行程</button>
  <button onclick="clearMap()">清空地图</button>
  <button id="toggleBase" onclick="toggleBaseMap()">政区图</button>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ==================== 景点坐标库 ==================== */
const locationMap = {
  "第比利斯":[41.7151,44.8271],"第比利斯老城":[41.6875,44.8067],"纳里卡拉要塞":[41.6866,44.8044],
  "和平桥":[41.7023,44.7966],"圣三一大教堂":[41.7053,44.7925],"硫磺浴池区":[41.6868,44.8042],
  "鲁斯塔维利大街":[41.7033,44.7933],"干桥市场":[41.7058,44.7908],"库塔伊西":[42.2527,42.7005],
  "格拉提修道院":[42.3983,42.6936],"梅斯蒂亚":[43.0467,42.7286],"乌树故里":[42.9127,43.0116],
  "巴统":[41.6168,41.6367],"巴统老城":[41.6183,41.6333],"阿里和尼诺雕像":[41.6178,41.6325],
  "欧洲广场":[41.6197,41.6336],"哥里":[41.984,44.1152],"斯大林博物馆":[41.9856,44.1136],
  "哥里要塞":[41.9875,44.1083],"乌普利斯齐赫洞穴城":[41.9675,44.1375],"西格纳吉":[41.6227,45.9228],
  "西格纳吉长城":[41.624,45.924],"克瓦雷利":[41.9546,45.8016],"克瓦雷利湖":[41.956,45.803],
  "阿拉韦尔迪修道院":[41.8444,45.3736],"伊卡托修道院":[41.8869,45.4536],"施乌姆塔修道院":[41.8969,45.4436],
  "斯捷潘茨明达":[42.6609,44.6411],"圣三一教堂（卡兹别克）":[42.6628,44.6044],"卡兹别克山":[42.6975,44.5467],
  "巴库里阿尼":[41.7021,43.5456],"古达乌里":[42.5847,44.6114],"博尔若米":[41.85,43.52],
  "博尔若米峡谷":[41.8444,43.5319],"茨哈尔图博温泉":[42.3256,42.5999],"苏拉姆山口":[42.0236,43.4986],
  "奇阿图拉矿山小镇":[42.3156,43.2986],"帕拉瓦尼湖":[41.4733,44.1333],"塔巴茨库里湖":[41.6833,43.0167],
  "萨加莫湖":[41.7167,44.0833],"阿巴斯塔马尼火山温泉":[41.4167,43.5833]
};

/* ==================== 底图 ==================== */
const layers = {
  osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OSM'}),
  political: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{attribution:'© CARTO'})
};
let currentBase = 'osm';
const map = L.map('map',{center:[41.7,44.8],zoom:7,layers:[layers.osm]});
const routeGroup = L.layerGroup().addTo(map);

function arrowDecorator(path){
  return L.polylineDecorator(path,{
    patterns:[{offset:'100%',repeat:0,symbol:L.Symbol.arrowHead({pixelSize:12,pathOptions:{fillOpacity:1,weight:0,color:'#333'}})}]
  });
}

/* ==================== Supabase 客户端 ==================== */
const SUPABASE_URL = 'https://fezxhcmiefdbvqmhczut.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlenhoY21pZWZkYnZxbWhjenV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxNjE1MDYsImV4cCI6MjA3MjczNzUwNn0.MdXghSsixHXeYhZKbMYuJGehMUvdbtixGNjMmBPMKKU';
const supabase = window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

/* ==================== 提取关键词 ==================== */
function extractKeyword(plan){
  for(let k in locationMap) if(plan.includes(k)) return k;
  return null;
}

/* ==================== 加载所有行程的天数 ==================== */
async function loadAllItineraryDays(){
  const {data,error} = await supabase
    .from('itinerary_days')
    .select('*')
    .order('day_number',{ascending:true});
  if(error){alert('读取失败：'+error.message);return;}
  if(!data || !data.length){alert('暂无行程数据');return;}
  drawAllDays(data);
}

function drawAllDays(days){
  routeGroup.clearLayers();
  const colors=['#e91e63','#9c27b0','#3f51b5','#00bcd4','#4caf50','#ffeb3b','#ff9800','#f44336','#795548','#607d8b'];
  let allCoords=[];
  days.forEach((d,idx)=>{
    const pts=d.plan.split(/[－\-–—~～]/)
                  .map(p=>extractKeyword(p.trim()))
                  .filter(Boolean)
                  .map(k=>locationMap[k]);
    if(pts.length<2) return;
    const color=colors[idx%colors.length];
    const line=L.polyline(pts,{color,weight:3});
    routeGroup.addLayer(line);
    routeGroup.addLayer(arrowDecorator(line));
    pts.forEach((latlng,i)=>{
      L.circleMarker(latlng,{radius:6,color,fillColor:'#fff',fillOpacity:1,weight:2})
       .bindPopup(`<b>行程${d.itinerary_id}·D${d.day_number}</b><br>${d.date}<br>${d.plan.split(/[－\-–—~～]/)[i]||''}`)
       .addTo(routeGroup);
    });
    allCoords=allCoords.concat(pts);
  });
  if(allCoords.length) map.fitBounds(L.latLngBounds(allCoords),{padding:[30,30]});
}

function clearMap(){
  routeGroup.clearLayers();
}

function toggleBaseMap(){
  if(currentBase==='osm'){
    map.removeLayer(layers.osm);map.addLayer(layers.political);
    currentBase='political';document.getElementById('toggleBase').textContent='标准图';
  }else{
    map.removeLayer(layers.political);map.addLayer(layers.osm);
    currentBase='osm';document.getElementById('toggleBase').textContent='政区图';
  }
}

/* ==================== 页面加载后自动全部显示 ==================== */
window.onload=()=>{
  loadAllItineraryDays();
};
</script>
</body>
</html>
