<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>方差计算器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        :root {
            --green: #58CC02;
            --green-hover: #4CAF50;
            --blue: #1CB0F6;
            --red: #FF4B4B;
            --yellow: #FFC800;
            --purple: #8E44AD;
            --dark: #2C3E50;
            --light: #F8F9FA;
            --white: #FFFFFF;
            --border: #E0E7FF;
            --shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            --radius: 20px;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 1600px;
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            display: grid;
            grid-template-columns: 300px 1fr 450px;
            min-height: 900px;
        }
        
        /* 左侧按钮栏 */
        .sidebar {
            background: var(--dark);
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .sidebar-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 15px;
            padding: 20px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .sidebar-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }
        
        .sidebar-btn.active {
            background: var(--green);
            box-shadow: 0 5px 15px rgba(88, 204, 2, 0.3);
        }
        
        .sidebar-btn i {
            font-size: 24px;
        }
        
        /* 中间主内容区 */
        .main-content {
            padding: 40px;
            background: var(--white);
            overflow-y: auto;
        }
        
        .section-title {
            font-size: 24px;
            color: var(--dark);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .section-title i {
            color: var(--green);
        }
        
        /* 虚拟键盘 */
        .virtual-keyboard {
            background: var(--light);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 3px solid var(--border);
        }
        
        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .keyboard-key {
            width: 70px;
            height: 70px;
            background: var(--white);
            border: 3px solid var(--border);
            border-radius: 15px;
            font-size: 28px;
            font-weight: 700;
            color: var(--dark);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            user-select: none;
        }
        
        .keyboard-key:hover {
            background: var(--light);
            transform: translateY(-3px);
        }
        
        .keyboard-key:active {
            transform: translateY(0);
            background: var(--green);
            color: white;
            border-color: var(--green);
        }
        
        .keyboard-key.wide {
            width: 154px;
        }
        
        .keyboard-key.clear {
            background: #FFEBEE;
            color: var(--red);
            border-color: #FFCDD2;
        }
        
        .keyboard-key.add {
            background: var(--green);
            color: white;
            border-color: var(--green);
        }
        
        .keyboard-key.calculate {
            background: var(--blue);
            color: white;
            border-color: var(--blue);
        }
        
        /* 数据展示区 */
        .data-display {
            background: var(--light);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            min-height: 150px;
            border: 3px solid var(--border);
        }
        
        .data-points {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .data-item {
            background: linear-gradient(135deg, var(--green), var(--blue));
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            animation: popIn 0.3s ease;
            box-shadow: 0 5px 15px rgba(28, 176, 246, 0.3);
        }
        
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .remove-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .remove-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }
        
        /* 专业箱线图容器 */
        .boxplot-container {
            background: var(--white);
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
            border: 3px solid var(--border);
            display: none;
        }
        
        .boxplot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .boxplot-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .boxplot-canvas-container {
            position: relative;
            width: 100%;
            height: 400px;
            background: var(--light);
            border-radius: 15px;
            overflow: hidden;
        }
        
        .boxplot-canvas {
            width: 100%;
            height: 100%;
        }
        
        .boxplot-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--dark);
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        /* 箱线图统计信息 */
        .boxplot-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }
        
        .boxplot-stat {
            background: var(--light);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-name {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }
        
        /* 右侧面板 */
        .right-panel {
            padding: 40px 30px;
            background: var(--light);
            border-left: 3px solid var(--border);
            overflow-y: auto;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--border);
        }
        
        .tab-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
            cursor: pointer;
            position: relative;
        }
        
        .tab-btn.active {
            color: var(--green);
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--green);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 公式展示 */
        .formula-display {
            background: var(--white);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 2px solid var(--border);
            display: none;
        }
        
        .formula {
            font-family: 'Cambria Math', 'Times New Roman', serif;
            font-size: 22px;
            line-height: 1.8;
            color: var(--dark);
            text-align: center;
        }
        
        /* 计算步骤 */
        .steps-container {
            background: var(--white);
            border-radius: 15px;
            padding: 25px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .step {
            background: var(--light);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--green);
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            background: var(--green);
            color: white;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 10px;
        }
        
        .step-content {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 16px;
            color: var(--dark);
        }
        
        /* 结果卡片 */
        .result-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .result-card {
            background: var(--white);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 2px solid var(--border);
            transition: transform 0.3s;
        }
        
        .result-card:hover {
            transform: translateY(-5px);
        }
        
        .result-card.primary {
            border-color: var(--green);
            background: linear-gradient(135deg, rgba(88, 204, 2, 0.1), rgba(76, 175, 80, 0.1));
        }
        
        .result-card.secondary {
            border-color: var(--blue);
            background: linear-gradient(135deg, rgba(28, 176, 246, 0.1), rgba(33, 150, 243, 0.1));
        }
        
        .result-value {
            font-size: 36px;
            font-weight: 800;
            color: var(--dark);
            margin: 15px 0;
        }
        
        .result-label {
            font-size: 14px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* 消息提示 */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 20px 25px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            animation: slideInRight 0.3s ease;
            display: none;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .message.success {
            background: #E8F5E9;
            color: #2E7D32;
            border-left: 5px solid var(--green);
        }
        
        .message.error {
            background: #FFEBEE;
            color: #C62828;
            border-left: 5px solid var(--red);
        }
        
        /* 统计信息 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-item {
            background: var(--white);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state i {
            font-size: 60px;
            margin-bottom: 20px;
            color: #ddd;
        }
        
        /* 百分位数表格 */
        .percentile-container {
            background: var(--white);
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
            border: 3px solid var(--border);
            display: none;
        }
        
        .percentile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .percentile-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .percentile-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .percentile-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .percentile-input:focus {
            border-color: var(--blue);
        }
        
        .percentile-btn {
            background: var(--blue);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .percentile-btn:hover {
            background: #0d8ecf;
        }
        
        .percentile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 10px;
        }
        
        .percentile-item {
            background: var(--light);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: transform 0.2s;
        }
        
        .percentile-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .percentile-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 5px;
        }
        
        .percentile-label {
            font-size: 12px;
            color: #666;
        }
        
        /* 响应式设计 */
        @media (max-width: 1400px) {
            .container {
                grid-template-columns: 280px 1fr 420px;
            }
        }
        
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr 400px;
                max-width: 1000px;
            }
            
            .sidebar {
                display: none;
            }
            
            .keyboard-key {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
            
            .keyboard-key.wide {
                width: 134px;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                max-width: 600px;
            }
            
            .right-panel {
                border-left: none;
                border-top: 3px solid var(--border);
            }
            
            .main-content, .right-panel {
                padding: 20px;
            }
            
            .keyboard-key {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .keyboard-key.wide {
                width: 114px;
            }
            
            .result-grid {
                grid-template-columns: 1fr;
            }
            
            .percentile-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- 左侧按钮栏 -->
        <div class="sidebar">
            <button class="sidebar-btn active" onclick="switchTab('input')">
                <i class="fas fa-keyboard"></i>
                输入数据
            </button>
            <button class="sidebar-btn" onclick="switchTab('boxplot')">
                <i class="fas fa-chart-bar"></i>
                箱线图
            </button>
            <button class="sidebar-btn" onclick="switchTab('percentile')">
                <i class="fas fa-percent"></i>
                百分位数
            </button>
            <button class="sidebar-btn" onclick="switchTab('formula')">
                <i class="fas fa-square-root-alt"></i>
                公式
            </button>
            <button class="sidebar-btn" onclick="switchTab('steps')">
                <i class="fas fa-calculator"></i>
                计算步骤
            </button>
            <button class="sidebar-btn" onclick="switchTab('results')">
                <i class="fas fa-chart-line"></i>
                结果
            </button>
            <div style="margin-top: auto; display: flex; flex-direction: column; gap: 10px;">
                <button class="sidebar-btn" onclick="clearAllData()" style="background: rgba(255, 75, 75, 0.1);">
                    <i class="fas fa-trash"></i>
                    清空
                </button>
                <button class="sidebar-btn" onclick="loadExample()" style="background: rgba(255, 200, 0, 0.1);">
                    <i class="fas fa-database"></i>
                    示例
                </button>
                <button class="sidebar-btn" onclick="generateRandomData()" style="background: rgba(140, 68, 173, 0.1);">
                    <i class="fas fa-random"></i>
                    随机
                </button>
            </div>
        </div>
        
        <!-- 中间主内容区 -->
        <div class="main-content" id="mainContent">
            <h2 class="section-title">
                <i class="fas fa-keyboard"></i> 内置键盘输入
            </h2>
            
            <!-- 虚拟键盘 -->
            <div class="virtual-keyboard">
                <div class="keyboard-row">
                    <div class="keyboard-key" onclick="pressKey('7')">7</div>
                    <div class="keyboard-key" onclick="pressKey('8')">8</div>
                    <div class="keyboard-key" onclick="pressKey('9')">9</div>
                    <div class="keyboard-key clear" onclick="clearCurrent()">C</div>
                </div>
                <div class="keyboard-row">
                    <div class="keyboard-key" onclick="pressKey('4')">4</div>
                    <div class="keyboard-key" onclick="pressKey('5')">5</div>
                    <div class="keyboard-key" onclick="pressKey('6')">6</div>
                    <div class="keyboard-key" onclick="pressKey('-')">-</div>
                </div>
                <div class="keyboard-row">
                    <div class="keyboard-key" onclick="pressKey('1')">1</div>
                    <div class="keyboard-key" onclick="pressKey('2')">2</div>
                    <div class="keyboard-key" onclick="pressKey('3')">3</div>
                    <div class="keyboard-key" onclick="pressKey('.')">.</div>
                </div>
                <div class="keyboard-row">
                    <div class="keyboard-key" onclick="pressKey('0')">0</div>
                    <div class="keyboard-key add wide" onclick="addNumber()">
                        <i class="fas fa-plus"></i> 添加数字
                    </div>
                    <div class="keyboard-key calculate" onclick="calculate()">
                        <i class="fas fa-equals"></i>
                    </div>
                </div>
            </div>
            
            <!-- 当前输入显示 -->
            <div style="text-align: center; margin: 20px 0;">
                <div style="font-size: 16px; color: #666; margin-bottom: 10px;">当前输入</div>
                <div id="currentInputDisplay" style="font-size: 48px; font-weight: 700; color: var(--green); min-height: 60px; font-family: 'Consolas', monospace;">
                    0
                </div>
            </div>
            
            <!-- 数据展示区 -->
            <div class="data-display">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="font-size: 18px; font-weight: 600; color: var(--dark);">
                        <i class="fas fa-database"></i> 数据列表
                        <span id="dataCountBadge" style="background: var(--green); color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; margin-left: 10px;">5</span>
                    </div>
                    <div style="font-size: 16px; color: #666;">
                        点击数字标签删除
                    </div>
                </div>
                
                <div class="data-points" id="dataPointsContainer">
                    <!-- 数据点动态生成 -->
                </div>
                
                <div id="emptyState" class="empty-state" style="display: none;">
                    <i class="fas fa-database"></i>
                    <p>还没有数据，请使用键盘输入数字</p>
                </div>
            </div>
            
            <!-- 专业箱线图 -->
            <div class="boxplot-container" id="boxplotContainer">
                <div class="boxplot-header">
                    <div class="boxplot-title">
                        <i class="fas fa-chart-bar"></i> 数据分布箱线图
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        鼠标悬停查看数值
                    </div>
                </div>
                
                <div class="boxplot-canvas-container">
                    <canvas id="boxplotCanvas" class="boxplot-canvas"></canvas>
              </div>
                
                <div class="boxplot-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FF6B6B;"></div>
                        <span>异常值</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4ECDC4;"></div>
                        <span>正常数据点</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FFD166;"></div>
                        <span>箱体 (IQR)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #06D6A0;"></div>
                        <span>中位数</span>
                    </div>
                </div>
                
                <div class="boxplot-stats" id="boxplotStats">
                    <!-- 箱线图统计信息动态生成 -->
                </div>
            </div>
            
            <!-- 百分位数表格 -->
            <div class="percentile-container" id="percentileContainer">
                <div class="percentile-header">
                    <div class="percentile-title">
                        <i class="fas fa-percent"></i> 数据百分位数
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        点击百分位数查看详细
                    </div>
                </div>
                
                <div class="percentile-controls">
                    <input type="number" id="customPercentile" class="percentile-input" placeholder="输入自定义百分位数 (0-100)" min="0" max="100" step="0.1">
                    <button class="percentile-btn" onclick="addCustomPercentile()">
                        <i class="fas fa-plus"></i> 添加
                    </button>
                </div>
                
                <div class="percentile-grid" id="percentileGrid">
                    <!-- 百分位数动态生成 -->
                </div>
            </div>
            
            <!-- 公式展示 -->
            <div class="formula-display" id="formulaDisplay">
                <div class="formula" id="formulaContent">
                    <!-- 公式内容动态生成 -->
                </div>
            </div>
        </div>
        
        <!-- 右侧面板 -->
        <div class="right-panel">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchRightTab('steps')">计算步骤</button>
                <button class="tab-btn" onclick="switchRightTab('results')">详细结果</button>
                <button class="tab-btn" onclick="switchRightTab('stats')">统计信息</button>
            </div>
            
            <!-- 计算步骤标签页 -->
            <div id="stepsTab" class="tab-content active">
                <div class="steps-container" id="stepsContainer">
                    <!-- 计算步骤动态生成 -->
                </div>
            </div>
            
            <!-- 详细结果标签页 -->
            <div id="resultsTab" class="tab-content">
                <div class="result-grid">
                    <div class="result-card primary">
                        <div class="result-value" id="resultMean">0.0000</div>
                        <div class="result-label">平均值 (x̄)</div>
                    </div>
                    <div class="result-card secondary">
                        <div class="result-value" id="resultPopVar">0.0000</div>
                        <div class="result-label">总体方差 (σ²)</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="resultSampVar">0.0000</div>
                        <div class="result-label">样本方差 (s²)</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="resultStdDev">0.0000</div>
                        <div class="result-label">标准差 (σ)</div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3 style="color: var(--dark); margin-bottom: 15px;">
                        <i class="fas fa-info-circle"></i> 数据摘要
                    </h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="statCount">0</div>
                            <div class="stat-label">数据个数</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statSum">0.00</div>
                            <div class="stat-label">总和</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statRange">0.00</div>
                            <div class="stat-label">极差</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statMin">0.00</div>
                            <div class="stat-label">最小值</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statMax">0.00</div>
                            <div class="stat-label">最大值</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statMedian">0.00</div>
                            <div class="stat-label">中位数</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 统计信息标签页 -->
            <div id="statsTab" class="tab-content">
                <div class="formula-display">
                    <div class="formula">
                        总体方差公式：<br>
                        σ² = Σ(xᵢᵢᵢ - μ)² / N<br><br>
                        样本方差公式：<br>
                        s² = Σ(xᵢᵢᵢ - x̄)² / (n-1)<br><br>
                        标准差：<br>
                        σ = √σ²
                    </div>
                </div>
                
                <div style="margin-top: 20px; background: var(--white); border-radius: 15px; padding: 20px;">
                    <h4 style="color: var(--dark); margin-bottom: 15px;">
                        <i class="fas fa-lightbulb"></i> 统计解释
                    </h4>
                    <p style="color: #666; line-height: 1.6; font-size: 14px;">
                        方差衡量数据的离散程度。值越大表示数据越分散，值越小表示数据越集中。<br><br>
                        样本方差使用 (n-1) 作为分母，这被称为贝塞尔修正，用于对总体方差进行无偏估计。
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 消息提示 -->
    <div id="message" class="message">
        <i class="fas fa-check-circle"></i>
        <span id="messageText"></span>
    </div>

    <script>
        // 数据存储
        let dataPoints = [91,78];
        let currentInput = '0';
        let currentTab = 'input';
        let boxplotCanvas = null;
        let boxplotCtx = null;
        let customPercentiles = new Set([25, 50, 75]); // 默认显示25%、50%、75%百分位数
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeCanvas();
            updateDisplay();
            calculate();
            updatePercentileGrid();
        });
        
        function initializeCanvas() {
            const canvas = document.getElementById('boxplotCanvas');
            if (canvas) {
                boxplotCanvas = canvas;
                boxplotCtx = canvas.getContext('2d');
                resizeCanvas();
            }
        }
        
        function resizeCanvas() {
            if (!boxplotCanvas) return;
            
            const container = document.querySelector('.boxplot-canvas-container');
            if (container) {
                const dpr = window.devicePixelRatio || 1;
                const rect = container.getBoundingClientRect();
                
                // 设置Canvas的实际大小
                boxplotCanvas.width = rect.width * dpr;
                boxplotCanvas.height = rect.height * dpr;
                
                // 设置Canvas的显示大小
                boxplotCanvas.style.width = rect.width + 'px';
                boxplotCanvas.style.height = rect.height + 'px';
                
                // 缩放上下文以处理高DPI显示
                boxplotCtx.scale(dpr, dpr);
            }
        }
        
        // 调整Canvas大小
        window.addEventListener('resize', function() {
            resizeCanvas();
            if (dataPoints.length >= 2 && currentTab === 'boxplot') {
                drawBoxPlot();
            }
        });
        
        // 键盘输入处理
        function pressKey(key) {
            if (currentInput === '0' && key !== '.' && key !== '-') {
                currentInput = key;
            } else {
                if (key === '.' && currentInput.includes('.')) {
                    return;
                }
                if (key === '-' && currentInput !== '0') {
                    currentInput = '-' + currentInput;
                    return;
                }
                if (key === '-' && currentInput.includes('-')) {
                    return;
                }
                if (currentInput === '-' && key === '.') {
                    currentInput = '-0.';
                    return;
                }
                currentInput += key;
            }
            updateCurrentInputDisplay();
        }
        
        function clearCurrent() {
            currentInput = '0';
            updateCurrentInputDisplay();
        }
        
        function updateCurrentInputDisplay() {
            const display = document.getElementById('currentInputDisplay');
            if (display) {
                display.textContent = currentInput;
            }
        }
        
        function addNumber() {
            const num = parseFloat(currentInput);
            if (isNaN(num)) {
                showMessage('请输入有效的数字', 'error');
                return;
            }
            
            dataPoints.push(num);
            currentInput = '0';
            updateDisplay();
            updateCurrentInputDisplay();
            showMessage(`已添加数字: ${num}`, 'success');
            
            // 自动计算
            calculate();
            updatePercentileGrid();
        }
        
        function removeData(index) {
            const removed = dataPoints.splice(index, 1)[0];
            updateDisplay();
            calculate();
            updatePercentileGrid();
            showMessage(`已删除数字: ${removed}`, 'success');
        }
        
        function clearAllData() {
            dataPoints = [];
            updateDisplay();
            calculate();
            updatePercentileGrid();
            showMessage('已清空所有数据', 'success');
        }
        
        function loadExample() {
            dataPoints = [12, 15, 18, 22, 25, 30, 28, 20, 19, 17, 35, 13, 16, 40, 14];
            updateDisplay();
            calculate();
            updatePercentileGrid();
            showMessage('已加载示例数据', 'success');
        }
        
        function generateRandomData() {
            const count = 15;
            dataPoints = Array.from({length: count}, () => 
                parseFloat((Math.random() * 50 + 10).toFixed(2))
            );
            updateDisplay();
            calculate();
            updatePercentileGrid();
            showMessage(`已生成 ${count} 个随机数据`, 'success');
        }
        
        function calculate() {
            if (dataPoints.length < 2) {
                showMessage('至少需要两个数据点才能计算方差', 'error');
                return;
            }
            
            // 计算基本统计量
            const n = dataPoints.length;
            const sum = dataPoints.reduce((a, b) => a + b, 0);
            const mean = sum / n;
            const sortedData = [...dataPoints].sort((a, b) => a - b);
            const min = sortedData[0];
            const max = sortedData[sortedData.length - 1];
            const range = max - min;
            
            // 计算中位数
            let median;
            if (n % 2 === 0) {
                median = (sortedData[n/2 - 1] + sortedData[n/2]) / 2;
            } else {
                median = sortedData[Math.floor(n/2)];
            }
            
            // 计算方差
            const squaredDifferences = dataPoints.map(x => Math.pow(x - mean, 2));
            const sumSquaredDifferences = squaredDifferences.reduce((a, b) => a + b, 0);
            const populationVariance = sumSquaredDifferences / n;
            const sampleVariance = n > 1 ? sumSquaredDifferences / (n - 1) : 0;
            const stdDev = Math.sqrt(populationVariance);
            
            // 更新结果
            updateResults({
                n, sum, mean, min, max, range, median,
                populationVariance, sampleVariance, stdDev
            });
            
            // 更新计算步骤
            updateCalculationSteps(dataPoints, mean, squaredDifferences, sumSquaredDifferences, n);
            
            // 更新箱线图统计
            updateBoxplotStats(sortedData);
            
            // 更新公式
            updateFormula();
            
            showMessage('计算完成！', 'success');
        }
        
        function updateDisplay() {
            const container = document.getElementById('dataPointsContainer');
            const emptyState = document.getElementById('emptyState');
            const dataCountBadge = document.getElementById('dataCountBadge');
            
            if (dataCountBadge) {
                dataCountBadge.textContent = dataPoints.length;
            }
            
            if (dataPoints.length === 0) {
                if (container) container.innerHTML = '';
                if (emptyState) emptyState.style.display = 'block';
            } else {
                if (emptyState) emptyState.style.display = 'none';
                if (container) {
                    container.innerHTML = dataPoints.map((value, index) => `
                        <div class="data-item">
                            ${value}
                            <button class="remove-btn" onclick="removeData(${index})">×</button>
                        </div>
                    `).join('');
                }
            }
        }
        
        function updateResults(results) {
            // 更新结果卡片
            const resultMean = document.getElementById('resultMean');
            const resultPopVar = document.getElementById('resultPopVar');
            const resultSampVar = document.getElementById('resultSampVar');
            const resultStdDev = document.getElementById('resultStdDev');
            
            if (resultMean) resultMean.textContent = results.mean.toFixed(4);
            if (resultPopVar) resultPopVar.textContent = results.populationVariance.toFixed(4);
            if (resultSampVar) resultSampVar.textContent = results.sampleVariance.toFixed(4);
            if (resultStdDev) resultStdDev.textContent = results.stdDev.toFixed(4);
            
            // 更新统计信息
            const statCount = document.getElementById('statCount');
            const statSum = document.getElementById('statSum');
            const statRange = document.getElementById('statRange');
            const statMin = document.getElementById('statMin');
            const statMax = document.getElementById('statMax');
            const statMedian = document.getElementById('statMedian');
            
            if (statCount) statCount.textContent = results.n;
            if (statSum) statSum.textContent = results.sum.toFixed(2);
            if (statRange) statRange.textContent = results.range.toFixed(2);
            if (statMin) statMin.textContent = results.min.toFixed(2);
            if (statMax) statMax.textContent = results.max.toFixed(2);
            if (statMedian) statMedian.textContent = results.median.toFixed(2);
        }
        
        function calculateBoxplotStats(sortedData) {
            if (sortedData.length < 2) return null;
            
            const n = sortedData.length;
            const min = sortedData[0];
            const max = sortedData[n - 1];
            
            // 计算四分位数
            const q1 = calculatePercentile(sortedData, 25);
            const median = calculatePercentile(sortedData, 50);
            const q3 = calculatePercentile(sortedData, 75);
            
            // 计算IQR
            const iqr = q3 - q1;
            
            // 计算触须边界
            const lowerWhisker = Math.max(min, q1 - 1.5 * iqr);
            const upperWhisker = Math.min(max, q3 + 1.5 * iqr);
            
            // 识别异常值
            const outliers = sortedData.filter(x => x < lowerWhisker || x > upperWhisker);
            
            return {
                min, max, q1, median, q3, iqr, lowerWhisker, upperWhisker, outliers
            };
        }
        
        function calculatePercentile(data, percentile) {
            if (data.length === 0) return 0;
            if (data.length === 1) return data[0];
            
            const index = (percentile / 100) * (data.length - 1);
            const lower = Math.floor(index);
            const upper = Math.ceil(index);
            
            if (lower === upper) {
                return data[lower];
            }
            
            const weight = index - lower;
            return data[lower] * (1 - weight) + data[upper] * weight;
        }
        
        function updateBoxplotStats(sortedData) {
            const stats = calculateBoxplotStats(sortedData);
            if (!stats) return;
            
            const container = document.getElementById('boxplotStats');
            if (container) {
                container.innerHTML = `
                    <div class="boxplot-stat">
                        <div class="stat-name">最小值</div>
                        <div class="stat-value">${stats.min.toFixed(2)}</div>
                    </div>
                    <div class="boxplot-stat">
                        <div class="stat-name">Q1 (25%)</div>
                        <div class="stat-value">${stats.q1.toFixed(2)}</div>
                    </div>
                    <div class="boxplot-stat">
                        <div class="stat-name">中位数</div>
                        <div class="stat-value">${stats.median.toFixed(2)}</div>
                    </div>
                    <div class="boxplot-stat">
                        <div class="stat-name">Q3 (75%)</div>
                        <div class="stat-value">${stats.q3.toFixed(2)}</div>
                    </div>
                    <div class="boxplot-stat">
                        <div class="stat-name">最大值</div>
                        <div class="stat-value">${stats.max.toFixed(2)}</div>
                    </div>
                    <div class="boxplot-stat">
                        <div class="stat-name">IQR</div>
                        <div class="stat-value">${stats.iqr.toFixed(2)}</div>
                    </div>
                    <div class="boxplot-stat">
                        <div class="stat-name">异常值</div>
                        <div class="stat-value">${stats.outliers.length}</div>
                    </div>
                `;
            }
        }
        
        function drawBoxPlot() {
            if (!boxplotCtx || dataPoints.length < 2) {
                console.log('Canvas context not available or insufficient data');
                return;
            }
            
            const sortedData = [...dataPoints].sort((a, b) => a - b);
            const stats = calculateBoxplotStats(sortedData);
            if (!stats) return;
            
            const container = document.querySelector('.boxplot-canvas-container');
            if (!container) return;
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // 清除Canvas
            boxplotCtx.clearRect(0, 0, width, height);
            
            // 计算绘制参数
            const padding = 60;
            const plotWidth = width - 2 * padding;
            const plotHeight = height - 2 * padding;
            const dataRange = stats.max - stats.min;
            
            // 防止除零错误
            if (dataRange === 0) {
                drawNoVarianceBoxPlot(width, height, stats.min);
                return;
            }
            
            const scaleX = (value) => padding + ((value - stats.min) / dataRange) * plotWidth;
            
            // 绘制背景
            drawBackground();
            
            // 绘制坐标轴
            drawAxes();
            
            // 绘制网格
            drawGrid(stats, scaleX);
            
            // 绘制箱体
            drawBox(stats, scaleX);
            
            // 绘制中位数
            drawMedian(stats, scaleX);
            
            // 绘制触须
            drawWhiskers(stats, scaleX);
            
            // 绘制数据点
            drawDataPoints(sortedData, stats, scaleX);
            
            function drawBackground() {
                boxplotCtx.fillStyle = '#f8f9fa';
                boxplotCtx.fillRect(0, 0, width, height);
                
                // 绘制渐变背景
                const gradient = boxplotCtx.createLinearGradient(0, 0, width, 0);
                gradient.addColorStop(0, 'rgba(88, 204, 2, 0.05)');
                gradient.addColorStop(1, 'rgba(28, 176, 246, 0.05)');
                boxplotCtx.fillStyle = gradient;
                boxplotCtx.fillRect(padding, padding, plotWidth, plotHeight);
            }
            
            function drawAxes() {
                boxplotCtx.strokeStyle = '#333';
                boxplotCtx.lineWidth = 2;
                boxplotCtx.fillStyle = '#333';
                boxplotCtx.font = '14px Arial';
                boxplotCtx.textAlign = 'center';
                
                // X轴
                boxplotCtx.beginPath();
                boxplotCtx.moveTo(padding, height - padding);
                boxplotCtx.lineTo(width - padding, height - padding);
                boxplotCtx.stroke();
                
                // Y轴
                boxplotCtx.beginPath();
                boxplotCtx.moveTo(padding, padding);
                boxplotCtx.lineTo(padding, height - padding);
                boxplotCtx.stroke();
                
                // X轴标签
                boxplotCtx.fillText('数据值', width / 2, height - 20);
                
                // Y轴标签
                boxplotCtx.save();
                boxplotCtx.translate(20, height / 2);
                boxplotCtx.rotate(-Math.PI / 2);
                boxplotCtx.textAlign = 'center';
                boxplotCtx.fillText('数据分布', 0, 0);
                boxplotCtx.restore();
            }
            
            function drawGrid(stats, scaleX) {
                boxplotCtx.strokeStyle = '#e0e0e0';
                boxplotCtx.lineWidth = 1;
                boxplotCtx.setLineDash([5, 5]);
                
                // 绘制网格线
                const gridPositions = [
                    { value: stats.min, label: '最小值' },
                    { value: stats.q1, label: 'Q1' },
                    { value: stats.median, label: '中位数' },
                    { value: stats.q3, label: 'Q3' },
                    { value: stats.max, label: '最大值' }
                ];
                
                gridPositions.forEach(item => {
                    const x = scaleX(item.value);
                    
                    // 垂直线
                    boxplotCtx.beginPath();
                    boxplotCtx.moveTo(x, padding);
                    boxplotCtx.lineTo(x, height - padding);
                    boxplotCtx.stroke();
                    
                    // 标签
                    boxplotCtx.fillStyle = '#666';
                    boxplotCtx.font = '12px Arial';
                    boxplotCtx.textAlign = 'center';
                    boxplotCtx.fillText(`${item.label}: ${item.value.toFixed(2)}`, x, height - padding + 20);
                });
                
                boxplotCtx.setLineDash([]);
            }
            
            function drawBox(stats, scaleX) {
                const boxX = scaleX(stats.q1);
                const boxWidth = scaleX(stats.q3) - boxX;
                const boxY = padding + plotHeight * 0.3;
                const boxHeight = plotHeight * 0.4;
                
                // 绘制箱体
                boxplotCtx.fillStyle = 'rgba(255, 209, 102, 0.3)';
                boxplotCtx.fillRect(boxX, boxY, boxWidth, boxHeight);
                
                // 箱体边框
                boxplotCtx.strokeStyle = '#FFD166';
                boxplotCtx.lineWidth = 3;
                boxplotCtx.strokeRect(boxX, boxY, boxWidth, boxHeight);
            }
            
            function drawMedian(stats, scaleX) {
                const medianX = scaleX(stats.median);
                const boxY = padding + plotHeight * 0.3;
                const boxHeight = plotHeight * 0.4;
                
                // 绘制中位数线
                boxplotCtx.strokeStyle = '#06D6A0';
                boxplotCtx.lineWidth = 4;
                boxplotCtx.beginPath();
                boxplotCtx.moveTo(medianX, boxY);
                boxplotCtx.lineTo(medianX, boxY + boxHeight);
                boxplotCtx.stroke();
                
                // 中位数标签
                boxplotCtx.fillStyle = '#06D6A0';
                boxplotCtx.font = 'bold 12px Arial';
                boxplotCtx.textAlign = 'center';
                boxplotCtx.fillText(`中位数: ${stats.median.toFixed(2)}`, medianX, boxY - 10);
            }
            
            function drawWhiskers(stats, scaleX) {
                const centerY = padding + plotHeight * 0.5;
                const whiskerLength = 10;
                
                boxplotCtx.strokeStyle = '#118AB2';
                boxplotCtx.lineWidth = 2;
                boxplotCtx.setLineDash([5, 3]);
                
                // 下触须
                const lowerWhiskerX = scaleX(stats.lowerWhisker);
                const q1X = scaleX(stats.q1);
                boxplotCtx.beginPath();
                boxplotCtx.moveTo(lowerWhiskerX, centerY);
                boxplotCtx.lineTo(q1X, centerY);
                boxplotCtx.stroke();
                
                // 上触须
                const upperWhiskerX = scaleX(stats.upperWhisker);
                const q3X = scaleX(stats.q3);
                boxplotCtx.beginPath();
                boxplotCtx.moveTo(q3X, centerY);
                boxplotCtx.lineTo(upperWhiskerX, centerY);
                boxplotCtx.stroke();
                
                boxplotCtx.setLineDash([]);
                
                // 绘制触须端点
                [stats.lowerWhisker, stats.upperWhisker].forEach((value, index) => {
                    const x = scaleX(value);
                    boxplotCtx.fillStyle = '#118AB2';
                    boxplotCtx.beginPath();
                    boxplotCtx.arc(x, centerY, 6, 0, Math.PI * 2);
                    boxplotCtx.fill();
                    
                    // 端点标签
                    boxplotCtx.fillStyle = '#118AB2';
                    boxplotCtx.font = 'bold 12px Arial';
                    boxplotCtx.textAlign = 'center';
                    const label = index === 0 ? '下界' : '上界';
                    boxplotCtx.fillText(`${label}: ${value.toFixed(2)}`, x, centerY + 20);
                });
            }
            
            function drawDataPoints(sortedData, stats, scaleX) {
                const centerY = padding + plotHeight * 0.5;
                const pointSpacing = 8;
                
                sortedData.forEach((value, index) => {
                    const x = scaleX(value);
                    const isOutlier = value < stats.lowerWhisker || value > stats.upperWhisker;
                    
                    // 在垂直方向分散数据点
                    const y = centerY + (index % 3 - 1) * pointSpacing;
                    
                    // 设置颜色
                    if (isOutlier) {
                        boxplotCtx.fillStyle = '#FF6B6B';
                        boxplotCtx.strokeStyle = '#C53030';
                        boxplotCtx.lineWidth = 2;
                    } else {
                        // 使用渐变色表示正常值
                        const hue = 200 + ((value - stats.min) / (stats.max - stats.min)) * 60;
                        boxplotCtx.fillStyle = `hsl(${hue}, 70%, 60%)`;
                        boxplotCtx.strokeStyle = `hsl(${hue}, 70%, 40%)`;
                        boxplotCtx.lineWidth = 1;
                    }
                    
                    // 绘制数据点
                    boxplotCtx.beginPath();
                    boxplotCtx.arc(x, y, 6, 0, Math.PI * 2);
                    boxplotCtx.fill();
                    boxplotCtx.stroke();
                    
                   // 为异常值添加外圈
                    if (isOutlier) {
                        boxplotCtx.strokeStyle = '#FF6B6B';
                        boxplotCtx.lineWidth = 1;
                        boxplotCtx.beginPath();
                        boxplotCtx.arc(x, y, 8, 0, Math.PI * 2);
                        boxplotCtx.stroke();
                    }
                });
            }
            
            function drawNoVarianceBoxPlot(width, height, value) {
                const centerX = width / 2;
                const centerY = height / 2;
                
                // 绘制单一值的箱线图
                boxplotCtx.fillStyle = '#f8f9fa';
                boxplotCtx.fillRect(0, 0, width, height);
                
                boxplotCtx.fillStyle = '#333';
                boxplotCtx.font = '16px Arial';
                boxplotCtx.textAlign = 'center';
                boxplotCtx.fillText('数据无方差，所有值相同', centerX, centerY - 20);
                boxplotCtx.fillText(`数值: ${value.toFixed(2)}`, centerX, centerY + 20);
                
                // 绘制一个点表示数据
                boxplotCtx.fillStyle = '#4ECDC4';
                boxplotCtx.beginPath();
                boxplotCtx.arc(centerX, centerY, 8, 0, Math.PI * 2);
                boxplotCtx.fill();
            }
            
            // 添加鼠标悬停交互
            setupMouseInteraction(stats, scaleX);
        }
        
        function setupMouseInteraction(stats, scaleX) {
            const canvas = document.getElementById('boxplotCanvas');
            if (!canvas) return;
            
            canvas.onmousemove = function(event) {
                const rect = canvas.getBoundingClientRect();
                const mouseX = event.clientX - rect.left;
                const mouseY = event.clientY - rect.top;
                
                // 这里可以添加悬停检测逻辑
                // 暂时先重新绘制
                drawBoxPlot();
            };
            
            canvas.onmouseleave = function() {
                drawBoxPlot();
            };
        }
        
        function updateCalculationSteps(data, mean, squaredDiffs, sumSquaredDiffs, n) {
            const stepsContainer = document.getElementById('stepsContainer');
            if (!stepsContainer) return;
            
            let stepsHTML = `
                <div class="step">
                    <span class="step-number">1</span>
                    <span class="step-content">计算平均值: x̄ = (${data.join(' + ')}) / ${n} = ${mean.toFixed(4)}</span>
                </div>
                
                <div class="step">
                    <span class="step-number">2</span>
                    <span class="step-content">计算每个数据与平均值的差:</span>
                </div>
            `;
            
            // 添加差值计算
            data.forEach((value, i) => {
                const diff = (value - mean).toFixed(4);
                stepsHTML += `
                    <div class="step" style="margin-left: 20px;">
                        <span class="step-content">x${i+1} - x̄ = ${value} - ${mean.toFixed(4)} = ${diff}</span>
                    </div>
                `;
            });
            
            stepsHTML += `
                <div class="step">
                    <span class="step-number">3</span>
                    <span class="step-content">计算每个差的平方:</span>
                </div>
            `;
            
            // 添加平方计算
            squaredDiffs.forEach((value, i) => {
                const diff = (data[i] - mean).toFixed(4);
                stepsHTML += `
                    <div class="step" style="margin-left: 20px;">
                        <span class="step-content">(${diff})² = ${value.toFixed(4)}</span>
                    </div>
                `;
            });
            
            stepsHTML += `
                <div class="step">
                    <span class="step-number">4</span>
                    <span class="step-content">计算平方和: Σ(xᵢᵢᵢ - x̄)² = ${sumSquaredDiffs.toFixed(4)}</span>
                </div>
                
                <div class="step">
                    <span class="step-number">5</span>
                    <span class="step-content">总体方差: σ² = ${sumSquaredDiffs.toFixed(4)} / ${n} = ${(sumSquaredDiffs/n).toFixed(4)}</span>
                </div>
            `;
            
            if (n > 1) {
                stepsHTML += `
                    <div class="step">
                        <span class="step-number">6</span>
                        <span class="step-content">样本方差: s² = ${sumSquaredDiffs.toFixed(4)} / (${n} - 1) = ${(sumSquaredDiffs/(n-1)).toFixed(4)}</span>
                    </div>
                `;
            }
            
            stepsContainer.innerHTML = stepsHTML;
        }
        
        function updateFormula() {
            const formulaContent = document.getElementById('formulaContent');
            if (!formulaContent) return;
            
            const mean = dataPoints.reduce((a, b) => a + b, 0) / dataPoints.length;
            formulaContent.innerHTML = `
                当前数据: {${dataPoints.join(', ')}}<br><br>
                平均值: μ = ${mean.toFixed(4)}<br><br>
                总体方差: σ² = Σ(xᵢᵢᵢ - μ)² / ${dataPoints.length}<br><br>
                样本方差: s² = Σ(xᵢᵢᵢ - μ)² / (${dataPoints.length} - 1)
            `;
        }
        
        // 百分位数功能
        function updatePercentileGrid() {
            const grid = document.getElementById('percentileGrid');
            if (!grid) return;
            
            if (dataPoints.length === 0) {
                grid.innerHTML = '<div class="empty-state"><i class="fas fa-database"></i><p>暂无数据，请先输入数据</p></div>';
                return;
            }
            
            // 添加1-100的百分位数
            let html = '';
            const sortedData = [...dataPoints].sort((a, b) => a - b);
            
            // 添加常用百分位数
            const commonPercentiles = [1, 5, 10, 25, 50, 75, 90, 95, 99];
            
            commonPercentiles.forEach(p => {
                if (!customPercentiles.has(p)) {
                    customPercentiles.add(p);
                }
            });
            
            // 将自定义百分位数转换为数组并排序
            const percentiles = Array.from(customPercentiles).sort((a, b) => a - b);
            
            percentiles.forEach(p => {
                const value = calculatePercentile(sortedData, p);
                html += `
                    <div class="percentile-item" onclick="showPercentileDetail(${p}, ${value.toFixed(4)})">
                        <div class="percentile-value">${value.toFixed(4)}</div>
                        <div class="percentile-label">${p}% 百分位数</div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }
        
        function addCustomPercentile() {
            const input = document.getElementById('customPercentile');
            if (!input) return;
            
            const value = parseFloat(input.value);
            if (isNaN(value) || value < 0 || value > 100) {
                showMessage('请输入0-100之间的有效百分位数', 'error');
                return;
            }
            
            if (customPercentiles.has(value)) {
                showMessage(`百分位数 ${value}% 已存在`, 'error');
                return;
            }
            
            customPercentiles.add(value);
            updatePercentileGrid();
            input.value = '';
            showMessage(`已添加百分位数: ${value}%`, 'success');
        }
        
        function showPercentileDetail(percentile, value) {
            showMessage(`${percentile}% 百分位数: ${value}`, 'success');
            
            // 这里可以添加更详细的显示逻辑，比如在右侧面板显示
            const stepsContainer = document.getElementById('stepsContainer');
            if (stepsContainer) {
                stepsContainer.innerHTML = `
                    <div class="step">
                        <span class="step-number">1</span>
                        <span class="step-content">数据排序: [${[...dataPoints].sort((a, b) => a - b).join(', ')}]</span>
                    </div>
                    <div class="step">
                        <span class="step-number">2</span>
                        <span class="step-content">计算位置: index = ${percentile}% × (${dataPoints.length} - 1) = ${((percentile/100) * (dataPoints.length - 1)).toFixed(4)}</span>
                    </div>
                    <div class="step">
                        <span class="step-number">3</span>
                        <span class="step-content">${percentile}% 百分位数 = ${value}</span>
                    </div>
                `;
            }
        }
        
        function switchTab(tab) {
            currentTab = tab;
            
            // 更新侧边栏按钮
            document.querySelectorAll('.sidebar-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // 显示/隐藏内容
            const boxplotContainer = document.getElementById('boxplotContainer');
            const formulaDisplay = document.getElementById('formulaDisplay');
            const percentileContainer = document.getElementById('percentileContainer');
            
            if (tab === 'input') {
                if (boxplotContainer) boxplotContainer.style.display = 'none';
                if (formulaDisplay) formulaDisplay.style.display = 'none';
                if (percentileContainer) percentileContainer.style.display = 'none';
            } else if (tab === 'boxplot') {
                if (boxplotContainer) {
                    boxplotContainer.style.display = 'block';
                    // 延迟绘制以确保容器已显示
                    setTimeout(() => {
                        resizeCanvas();
                        if (dataPoints.length >= 2) {
                            drawBoxPlot();
                        }
                    }, 100);
                }
                if (formulaDisplay) formulaDisplay.style.display = 'none';
                if (percentileContainer) percentileContainer.style.display = 'none';
            } else if (tab === 'percentile') {
                if (boxplotContainer) boxplotContainer.style.display = 'none';
                if (formulaDisplay) formulaDisplay.style.display = 'none';
                if (percentileContainer) {
                    percentileContainer.style.display = 'block';
                    updatePercentileGrid();
                }
            } else if (tab === 'formula') {
                if (boxplotContainer) boxplotContainer.style.display = 'none';
                if (formulaDisplay) formulaDisplay.style.display = 'block';
                if (percentileContainer) percentileContainer.style.display = 'none';
            }
        }
        
        function switchRightTab(tab) {
            // 更新标签按钮
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // 显示对应内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const tabElement = document.getElementById(tab + 'Tab');
            if (tabElement) {
                tabElement.classList.add('active');
            }
        }
        
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            const messageText = document.getElementById('messageText');
            
            if (!messageEl || !messageText) return;
            
            messageText.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'flex';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }
        
        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            if ('0123456789'.includes(e.key)) {
                pressKey(e.key);
            } else if (e.key === '.' || e.key === ',') {
                pressKey('.');
            } else if (e.key === '-' || e.key === '_') {
                pressKey('-');
            } else if (e.key === 'Enter') {
                addNumber();
            } else if (e.key === 'Escape' || e.key === 'Delete') {
                clearCurrent();
            } else if (e.key === 'c' || e.key === 'C') {
                if (e.ctrlKey) {
                    clearAllData();
                }
            } else if (e.key === '=' || e.key === '+') {
                calculate();
            }
        });
    </script>
</body>
</html>